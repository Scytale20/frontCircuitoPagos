<div class="container">
  <div
    class="modal fade"
    id="facturaModal"
    tabindex="-1"
    aria-labelledby="exampleModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header header text-center mb-2">
          <h3 class="modal-title form-title fs-2 w-100" id="exampleModalLabel">
            Registrar Factura
          </h3>
          <button
            type="button"
            class="btn-close btn-close-white"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>
        <div class="modal-body p-0">
          <form
            class="mt-5 ps-5 pe-5"
            [formGroup]="nuevaFacturaForm"
            (ngSubmit)="registrarFactura()"
          >
            <input type="hidden" name="id" formControlName="id" />
            <div class="ps-1 pe-1">
              <div class="row g-4 d-flex">
                <div class="col-sm-2">
                  <label for="fechaEmision" class="form-label text-muted"
                    >Fecha Emision:</label
                  >
                  <input
                    type="date"
                    class="form-control text-muted"
                    id="fechaEmision"
                    formControlName="fechaEmision"
                  />
                </div>
                <div class="col-sm-3">
                  <label for="proveedor" class="form-label text-muted"
                    >Proveedor:</label
                  >
                  <select
                    type="text"
                    class="form-select text-muted"
                    id="Proveedor"
                    formControlName="nombre"
                    (change)="onProveedorChange($event)"
                    [ngClass]="{
                      'is-invalid':
                        proveedorField.errors && proveedorField.touched
                    }"
                  >
                    @for(proveedor of proveedores; track proveedor){
                    <option [value]="proveedor.razonSocial">
                      {{ proveedor.razonSocial }}
                    </option>

                    }
                  </select>
                </div>
                <!-- Botón para abrir el Offcanvas -->
                <div class="col-sm-2 d-flex align-items-center">
                  <button
                    type="button"
                    class="btn btn-success btn-sm agregar-button"
                    data-bs-toggle="offcanvas"
                    data-bs-target="#proveedorDesdeFacturaOffcanvas"
                    aria-controls="proveedorDesdeFacturaOffcanvas"
                  >
                    <i class="agregar-icon bi bi-plus-lg"></i>
                  </button>
                </div>
                <!-- Offcanvas para Nuevo Proveedor -->
                <div
                  class="offcanvas offcanvas-end"
                  tabindex="-1"
                  id="proveedorDesdeFacturaOffcanvas"
                  aria-labelledby="proveedorDesdeFacturaOffcanvasLabel"
                >
                  <div class="offcanvas-header">
                    <h5
                      class="offcanvas-title text-muted"
                      id="proveedorDesdeFacturaOffcanvasLabel"
                    >
                      Ingresar Nuevo Proveedor
                    </h5>
                    <button
                      type="button"
                      class="btn-close text-reset"
                      data-bs-dismiss="offcanvas"
                      aria-label="Close"
                    ></button>
                  </div>

                  <div class="offcanvas-body mt-5">
                    <form
                      class="mt-3 ps-3 pe-3"
                      [formGroup]="proveedorFormDesdeFactura"
                      (ngSubmit)="registrarProveedorDesdeFactura()"
                    >
                      <input type="hidden" name="id" formControlName="id" />

                      <!-- Razon Social -->
                      <div class="mb-2">
                        <label for="razonSocial" class="form-label text-muted"
                          >Razón Social:</label
                        >
                        <input
                          type="text"
                          class="form-control"
                          id="razonSocial"
                          formControlName="razonSocial"
                          [ngClass]="{
                            'is-invalid':
                              razonSocialField.errors &&
                              razonSocialField.touched,
                            'is-valid':
                              !razonSocialField.errors &&
                              razonSocialField.touched
                          }"
                        />
                        @if(razonSocialField.hasError('required')){
                        <p class="invalid-feedback">Ingrese Razon Social</p>
                        }
                      </div>

                      <!-- CUIT -->
                      <div class="mb-2">
                        <label for="cuit" class="form-label text-muted"
                          >CUIT:</label
                        >
                        <input
                          type="text"
                          class="form-control"
                          id="cuit"
                          formControlName="cuit"
                          maxlength="11"
                          [ngClass]="{
                            'is-invalid': cuitField.errors && cuitField.touched,
                            'is-valid': !cuitField.errors && cuitField.touched
                          }"
                        />
                        @if(cuitField.hasError('required')){
                        <p class="invalid-feedback">Ingrese CUIT</p>
                        }@else if(cuitField.hasError('minlength') ||
                        cuitField.hasError('maxlength')) {
                        <p class="invalid-feedback">
                          Debe contener 11 caracteres
                        </p>
                        }
                      </div>

                      <!-- Condición IVA -->
                      <div class="mb-4">
                        <label
                          for="condicionIva"
                          class="col-form-label text-muted"
                          >Condición IVA:</label
                        >
                        <select
                          class="form-select"
                          id="condicionIva"
                          formControlName="condicionIva"
                          [ngClass]="{
                            'is-invalid':
                              condicionIvaField.errors &&
                              condicionIvaField.touched,
                            'is-valid':
                              !condicionIvaField.errors &&
                              condicionIvaField.touched
                          }"
                        >
                          <option selected disabled value="" class="text-muted">
                            Seleccione una opción
                          </option>
                          <option value="Responsable Inscripto">
                            Responsable Inscripto
                          </option>
                          <option value="Responsable no Inscripto">
                            Responsable no Inscripto
                          </option>
                          <option value="No Responsable">No Responsable</option>
                          <option value="Sujeto Exento">Sujeto Exento</option>
                          <option value="Consumidor Final">
                            Consumidor Final
                          </option>
                          <option value="Responsable Monotributo">
                            Responsable Monotributo
                          </option>
                          <option value="Sujeto no Categorizado">
                            Sujeto no Categorizado
                          </option>
                          <option value="Monotributista Social">
                            Monotributista Social
                          </option>
                        </select>
                        @if(condicionIvaField.hasError('required')){
                        <p class="invalid-feedback">Selecciona una opcion</p>
                        }
                      </div>

                      <!-- Botón Registrar -->
                      <div class="d-grid mx-auto mt-5 mb-5">
                        <button type="submit" class="btn btn-outline-primary">
                          Registrar
                        </button>
                      </div>
                      <!-- Recordatorio para el usuario -->
                      <div
                        class="col-12 mt-2 p-1 alert alert-warning"
                        role="alert"
                      >
                        <small class="text-muted">
                          Nota: No olvide completar los datos restantes del
                          proveedor en el módulo
                          <strong>Proveedores</strong>.
                        </small>
                      </div>
                    </form>
                  </div>
                </div>

                <div class="col-sm-1">
                  <label for="letraFactura" class="form-label text-muted"
                    >Letra:</label
                  >
                  <select
                    type="text"
                    class="form-select text-muted"
                    id="letraFactura"
                    formControlName="letraFactura"
                  >
                    <option value="A" selected>A</option>
                    <option value="B">B</option>
                    <option value="C">C</option>
                    <option value="E">E</option>
                  </select>
                </div>

                <div class="col-sm-3">
                  <label for="numeroFactura" class="form-label text-muted"
                    >Factura N°:</label
                  >
                  <input
                    type="text"
                    class="form-control text-muted"
                    id="numeroFactura"
                    formControlName="numeroFactura"
                    maxlength="14"
                    [ngClass]="{
                      'is-invalid':
                        numeroFacturaField.errors && numeroFacturaField.touched
                    }"
                  />
                </div>
                <div class="mb-5 col-sm-2">
                  <label for="fechaVencimiento" class="form-label text-muted"
                    >Fecha Vencimiento:</label
                  >
                  <input
                    type="date"
                    class="form-control text-muted"
                    id="fechaVencimiento"
                    formControlName="fechaVencimiento"
                  />
                </div>
                <div class="col-sm-3">
                  <label for="cuit" class="form-label text-muted">CUIT:</label>
                  <input
                    type="text"
                    class="form-control text-muted"
                    id="cuit"
                    formControlName="cuit"
                    readonly
                  />
                </div>
                <div class="col-sm-12"></div>
                <div class="col-sm-12"></div>
              </div>

              <div class="row mb-5 d-flex">
                <div class="mb-2 col-sm-1">
                  <label for="cantidad" class="form-label text-muted"
                    >Cantidad:</label
                  >
                  <input
                    type="number"
                    class="form-control text-muted"
                    id="cantidad"
                    formControlName="cantidad"
                    min="1"
                    max="999999"
                    [ngClass]="{
                      'is-invalid':
                        cantidadField.errors && cantidadField.touched
                    }"
                  />
                </div>
                <div class="mb-2 col-sm-5">
                  <label for="concepto" class="form-label text-muted"
                    >Descripcion:</label
                  >
                  <input
                    type="text"
                    class="form-control text-muted"
                    id="concepto"
                    formControlName="concepto"
                    maxlength="250"
                    [ngClass]="{
                      'is-invalid':
                        conceptoField.errors && conceptoField.touched
                    }"
                  />
                </div>

                <div class="mb-2 col-sm-1">
                  <label for="unidadMedida" class="form-label text-muted"
                    >Un.Med:</label
                  >
                  <input
                    type="text"
                    class="form-control text-muted"
                    id="unidadMedida"
                    formControlName="unidadMedida"
                    maxlength="4"
                    pattern="^[a-zA-Z]+$"
                    [ngClass]="{
                      'is-invalid': unidadField.errors && unidadField.touched
                    }"
                  />
                </div>
                <div class="mb-2 col-sm-2">
                  <label for="precioUnitario" class="form-label text-muted"
                    >Precio Unitario:</label
                  >
                  <input
                    type="number"
                    class="form-control text-muted"
                    id="precioUnitario"
                    formControlName="precioUnitario"
                    min="0.01"
                    max="99999999"
                    [ngClass]="{
                      'is-invalid': precioField.errors && precioField.touched
                    }"
                  />
                </div>
                <div class="mb-2 col-sm-1">
                  <label for="alicuotaIva" class="form-label text-muted"
                    >Impuesto:</label
                  >
                  <input
                    type="number"
                    class="form-control text-muted"
                    id="alicuotaIva"
                    formControlName="alicuotaIva"
                    [ngClass]="{
                      'is-invalid':
                        impuestoField.errors && impuestoField.touched
                    }"
                  />
                </div>
                <div class="mb-2 col-sm-2">
                  <label for="totalFactura" class="form-label text-muted"
                    >Total:</label
                  >
                  <input
                    type="number"
                    class="form-control text-muted"
                    id="totalFactura"
                    formControlName="totalFactura"
                    readonly
                  />
                  <input
                    type="hidden"
                    formControlName="subtotal"
                    id="subtotal"
                  />
                </div>
              </div>
              <div class="row"></div>

              <div class="mt-5">
                <div class="row">
                  <div class="col-sm-7"></div>
                  <div class="col-sm-2 fs-5">Subtotal:$</div>
                  <div class="col-sm-3 fs-5 text-end">
                    {{ subtotal | number : "1.2-2" }}
                  </div>
                </div>
                <div class="row">
                  <div class="col-sm-7"></div>
                  <div class="col-sm-2 fs-5">Impuestos: $</div>
                  <div class="col-sm-3 fs-5 text-end">
                    {{ impuestos | number : "1.2-2" }}
                  </div>
                </div>
                <div class="row">
                  <div class="col-sm-7"></div>
                  <div class="col-sm-5">
                    <hr />
                  </div>
                </div>

                <div class="row">
                  <div class="col-sm-7"></div>
                  <div class="col-sm-2 fs-4 fw-bolder">Total: $</div>
                  <div class="col-sm-3 fs-4 fw-bolder text-end">
                    {{ total | number : "1.2-2" }}
                  </div>
                </div>
              </div>
            </div>
            <div class="modal-footer mt-5">
              <div class="d-flex justify-content-end">
                @if(registrar){
                <button type="submit" class="btn btn-outline-primary mt-3 mb-3">
                  Registrar
                </button>
                } @if(actualizar){
                <button type="submit" class="btn btn-outline-primary mt-3 mb-3">
                  Actualizar
                </button>
                }
              </div>
            </div>
          </form>
          <div class="color-footer"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<app-table
  [titulosColumnas]="titulosTabla"
  [datosTabla]="facturas"
  [target]="modalTarget"
  (cambiarRegistrar)="botonRegistrar()"
  (cambiarActualizar)="botonActualizar()"
  (traerNumero)="nuevaFacturaModal()"
  (editar)="editarFactura($event)"
></app-table>
